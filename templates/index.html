<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Si√™u Sao C·∫£m X√∫c - Kids Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div class="main-container">
        <!-- B·∫¢NG ƒêI·ªÇM -->
        <div class="sidebar left-panel">
            <div class="panel-box score-box">
                <div class="label">ƒêI·ªÇM S·ªê</div>
                <div id="score" class="value">0</div>
            </div>
            <div class="panel-box combo-box">
                <div class="label">COMBO üî•</div>
                <div id="combo" class="value">0</div>
            </div>
            <div class="panel-box lives-box">
                <div class="label">M·∫†NG ‚ù§Ô∏è</div>
                <div id="lives" class="value">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            </div>
            <!-- N√∫t b·∫≠t/t·∫Øt nh·∫°c n·ªÅn -->
            <div class="panel-box music-control" onclick="toggleBGM()">
                <div class="label">NH·∫†C N·ªÄN üéµ</div>
                <div id="bgm-status" class="value" style="font-size: 20px">B·∫¨T</div>
            </div>
            <div class="panel-box voice-control" onclick="toggleVoice()">
                <div class="label">HI·ªÜU ·ª®NG üîä</div>
                <div id="voice-status" class="value" style="font-size: 18px">B·∫¨T</div>
            </div>
            <div class="panel-box voice-mode" onclick="toggleRecorded()">
                <div class="label">CH·∫æ ƒê·ªò üéµ</div>
                <div id="voice-mode-status" class="value" style="font-size: 16px">HI·ªÜU ·ª®NG</div>
            </div>
        </div>

        <!-- TV SCREEN -->
        <div class="tv-screen">
            <img src="{{ url_for('video_feed') }}" class="video-feed">
            
            <div id="top-msg" class="overlay-top">S·∫¥N S√ÄNG...</div>

            <div id="target-emoji" class="emoji-card hidden">
                <div id="target-icon">üòÉ</div>
                <div id="target-label">VUI V·∫∫</div>
            </div>

            <div id="result-popup" class="result-pop hidden">TUY·ªÜT V·ªúI!</div>

            <div class="beat-container">
                <div id="beat-bar" class="beat-bar"></div>
            </div>
        </div>

        <!-- CONTROLS -->
        <div class="bottom-panel">
            <button id="start-btn" onclick="initGame()">‚ñ∂ B·∫ÆT ƒê·∫¶U QU·∫®Y</button>
            <div class="ai-status">AI ƒêang Th·∫•y: <span id="player-emo">...</span></div>
        </div>
    </div>

    <script>
        // --- 1. C·∫§U H√åNH √ÇM THANH T√ôY CH·ªàNH ---
        // Load c√°c file nh·∫°c t·ª´ th∆∞ m·ª•c static/sounds
        const sounds = {
            bgm: new Audio("{{ url_for('assets', filename='beat.wav') }}"),
            beat: new Audio("{{ url_for('assets', filename='beat.wav') }}"),
            correct: new Audio("{{ url_for('assets', filename='success.wav') }}"),
            wrong: new Audio("{{ url_for('assets', filename='fail.wav') }}"),
            tick: new Audio("{{ url_for('assets', filename='beat.wav') }}"), // Ti·∫øng nh·ªãp ph·ª• (t√πy ch·ªçn)
            // Generated cheerful music (auto-created by server on startup)
            v_prompt: new Audio("{{ url_for('assets', filename='v_prompt.wav') }}"),
            v_correct: new Audio("{{ url_for('assets', filename='v_correct.wav') }}"),
            v_wrong: new Audio("{{ url_for('assets', filename='v_wrong.wav') }}"),
            v_gameover: new Audio("{{ url_for('assets', filename='v_gameover.wav') }}")
        };

        // C·∫•u h√¨nh nh·∫°c n·ªÅn
        sounds.bgm.loop = true; // T·ª± ƒë·ªông l·∫∑p l·∫°i
        sounds.bgm.volume = 0.4; // √Çm l∆∞·ª£ng v·ª´a ph·∫£i (40%)
        
        // Tinh ch·ªânh hi·ªáu ·ª©ng
        sounds.beat.volume = 1.0;
        sounds.correct.volume = 0.8;
        sounds.wrong.volume = 0.6;

        // H√†m ph√°t √¢m thanh (ƒë·ªÉ kh√¥ng b·ªã l·ªói khi b·∫•m nhanh)
        function playSfx(name) {
            let s = sounds[name];
            if (s) {
                s.currentTime = 0; // Tua v·ªÅ ƒë·∫ßu ƒë·ªÉ ph√°t ngay l·∫≠p t·ª©c
                s.play().catch(e => console.log("Ch∆∞a b·∫•m Start n√™n ch∆∞a c√≥ ti·∫øng"));
            }
        }

        function toggleBGM() {
            if (sounds.bgm.paused) {
                sounds.bgm.play();
                document.getElementById('bgm-status').innerText = "B·∫¨T";
                document.getElementById('bgm-status').style.color = "#2ecc71";
            } else {
                sounds.bgm.pause();
                document.getElementById('bgm-status').innerText = "T·∫ÆT";
                document.getElementById('bgm-status').style.color = "#e74c3c";
            }
        }

        // --- SOUND EFFECTS MODE (no long narration) ---
        let soundEnabled = true;

        function toggleVoice() {
            soundEnabled = !soundEnabled;
            const el = document.getElementById('voice-status');
            if (soundEnabled) { el.innerText = 'B·∫¨T'; el.style.color = '#2ecc71'; }
            else { el.innerText = 'T·∫ÆT'; el.style.color = '#e74c3c'; }
        }

        function toggleRecorded() {
            // Kept for UI compatibility - switches between all effects or quiet mode
            const el = document.getElementById('voice-mode-status');
            const isFx = el.innerText === 'HI·ªÜU ·ª®NG';
            el.innerText = isFx ? 'IM' : 'HI·ªÜU ·ª®NG';
            el.style.color = isFx ? '#e74c3c' : '#2ecc71';
        }

        function playSfxCue(type) {
            if (!soundEnabled) return;
            const key = 'v_' + type;
            const audio = sounds[key];
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e=>console.log('play cue failed',e));
            }
        }

        // --- 2. LOGIC GAME ---
        let score = 0, combo = 0, lives = 3, bpm = 85; // BPM cho tr·∫ª em
        let isPlaying = false;
        let targetEmo = "neutral";
        let playerEmo = "neutral";
        
        const emotions = ["happy", "surprise", "tongue_out", "neutral"];
        const emoMap = {"happy":"VUI V·∫∫ üòä", "surprise":"B·∫§T NG·ªú üò≤", "tongue_out":"L√à L∆Ø·ª†I üòù", "neutral":"B√åNH TH∆Ø·ªúNG üòê"};
        
        let beatCount = 0;
        let gameTimer = null;

        function gameLoop() {
            if (!isPlaying) return;
            
            let phase = beatCount % 4;
            updateUIPhase(phase);
            
            // --- X·ª¨ L√ù √ÇM THANH THEO NH·ªäP ---
            if (phase === 0) {
                // Nh·ªãp 4: CH·ªêT (B√ôM!)
                // N·∫øu b·∫°n c√≥ file beat.mp3 nghe "Ch√°t" th√¨ r·∫•t hay
                playSfx('beat'); 
            } else {
                // Nh·ªãp 1, 2, 3: (T√°ch t√°ch t√°ch)
                // C√≥ th·ªÉ d√πng l·∫°i beat.mp3 nh∆∞ng volume nh·ªè ho·∫∑c file tick.mp3 ri√™ng
                // playSfx('tick'); // B·ªè comment n·∫øu mu·ªën nghe ti·∫øng ƒë·∫øm nh·ªãp
            }

            // T√≠nh to√°n th·ªùi gian cho nh·ªãp ti·∫øp theo d·ª±a tr√™n BPM
            // C√¥ng th·ª©c: 60000ms / BPM = s·ªë ms cho 1 nh·ªãp
            let interval = (60000 / bpm);
            
            gameTimer = setTimeout(gameLoop, interval);
            beatCount++;
        }

        function updateUIPhase(phase) {
            let msg = document.getElementById('top-msg');
            let emoCard = document.getElementById('target-emoji');
            let bar = document.getElementById('beat-bar');
            
            // Reset thanh beat
            bar.style.transition = 'none'; bar.style.width = '100%';
            setTimeout(() => { 
                bar.style.transition = `width ${(60/bpm)*0.9}s linear`; 
                bar.style.width = '0%'; 
            }, 20);

            if (phase === 1) {
                targetEmo = emotions[Math.floor(Math.random() * emotions.length)];
                msg.innerText = "CH·ª¶ ƒê·ªÄ L√Ä..."; msg.style.color = "#fff";
                emoCard.classList.add('hidden');
                document.getElementById('result-popup').classList.add('hidden');
            }
            else if (phase === 2) {
                msg.innerText = emoMap[targetEmo]; msg.style.color = "#f1c40f";
                document.getElementById('target-icon').innerText = targetEmo === "happy" ? "üòÅ" : (targetEmo==="surprise"?"üò≤":(targetEmo==="tongue_out"?"üòù":"üòê"));
                document.getElementById('target-label').innerText = emoMap[targetEmo];
                emoCard.classList.remove('hidden');
                // small animation cue and sound effect
                emoCard.classList.add('animate-target');
                setTimeout(()=> emoCard.classList.remove('animate-target'), 900);
                playSfxCue('prompt');
            }
            else if (phase === 3) {
                msg.innerText = "CHU·∫®N B·ªä...";
            }
            else if (phase === 0) {
                checkWin();
            }
        }

        function checkWin() {
            let result = document.getElementById('result-popup');
            let correct = (playerEmo === targetEmo);
            if(targetEmo === "neutral" && playerEmo !== "neutral") correct = false;

            if (correct) {
                score += 10 + combo; combo++;
                result.innerText = "TUY·ªÜT V·ªúI! ‚≠ê"; result.className = "result-pop win";
                playSfx('correct');
                playSfxCue('correct');
                if(combo % 5 === 0) bpm += 5; 
            } else {
                combo = 0; lives--;
                result.innerText = "SAI R·ªíI! ‚ùå"; result.className = "result-pop lose";
                playSfx('wrong');
                playSfxCue('wrong');
                if (lives <= 0) gameOver();
            }
            result.classList.remove('hidden');
            updateStats();
        }

        function updateStats() {
            document.getElementById('score').innerText = score;
            document.getElementById('combo').innerText = combo;
            document.getElementById('lives').innerText = "‚ù§Ô∏è".repeat(lives);
        }

        function gameOver() {
            isPlaying = false;
            clearTimeout(gameTimer);
            sounds.bgm.pause(); // T·∫Øt nh·∫°c n·ªÅn
            document.getElementById('top-msg').innerText = "H·∫æT GI·ªú!";
            document.getElementById('result-popup').innerText = "GAME OVER";
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('start-btn').innerText = "CH∆†I L·∫†I?";
            playSfxCue('gameover');
        }

        function initGame() {
            // Ph·∫£i c√≥ t∆∞∆°ng t√°c ng∆∞·ªùi d√πng m·ªõi ph√°t nh·∫°c ƒë∆∞·ª£c
            playSfx('bgm'); 
            
            score = 0; combo = 0; lives = 3; bpm = 85; beatCount = 1;
            isPlaying = true;
            document.getElementById('start-btn').style.display = 'none';
            updateStats();
            gameLoop();
        }

        // C·∫≠p nh·∫≠t AI li√™n t·ª•c
        setInterval(() => {
            fetch('/get_emotion').then(r => r.json()).then(d => {
                playerEmo = d.emotion;
                document.getElementById('player-emo').innerText = emoMap[playerEmo] || "...";
            });
        }, 100);
    </script>
</body>
</html>