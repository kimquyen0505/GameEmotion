<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Game C·∫£m X√∫c Vui Nh·ªôn</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;700&display=swap&subset=vietnamese" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div class="main-container">
        <!-- B·∫¢NG ƒêI·ªÇM -->
        <div class="sidebar left-panel">
            <div class="panel-box score-box">
                <div class="label">ƒêI·ªÇM S·ªê</div>
                <div id="score" class="value">0</div>
            </div>
            <div class="panel-box combo-box">
                <div class="label">COMBO üî•</div>
                <div id="combo" class="value">0</div>
            </div>
            <div class="panel-box lives-box">
                <div class="label">M·∫†NG ‚ù§Ô∏è</div>
                <div id="lives" class="value">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            </div>
            <div class="panel-box music-control" onclick="toggleBGM()">
                <div class="label">NH·∫†C N·ªÄN üéµ</div>
                <div id="bgm-status" class="value">B·∫¨T</div>
            </div>
        </div>

        <!-- M√ÄN H√åNH GAME -->
        <div class="tv-screen">
            <img src="{{ url_for('video_feed') }}" class="video-feed">
            <div id="top-msg" class="overlay-top">CH·ªú M·ªòT CH√öT...</div>

            <div id="target-emoji" class="emoji-card hidden">
                <div id="target-icon">üòÅ</div>
                <div id="target-label">VUI V·∫∫</div>
            </div>

            <div id="result-popup" class="result-pop hidden">ƒê√öNG!</div>
            <div class="beat-container"><div id="beat-bar" class="beat-bar"></div></div>
        </div>

        <!-- CONTROL -->
        <div class="bottom-panel">
            <button id="start-btn" onclick="initGame()" disabled style="background:#95a5a6; cursor:not-allowed;">‚è≥ ƒêANG H·ªåC KHU√îN M·∫∂T...</button>
            <div class="ai-status">AI th·∫•y: <span id="player-emo" style="color:yellow; font-weight:bold;">...</span></div>
        </div>
    </div>

    <script>
        // C·∫•u h√¨nh √Çm thanh (n·∫øu kh√¥ng c√≥ file v·∫´n ch·∫°y √™m ru)
        const sounds = {
            bgm: new Audio("{{ url_for('assets', filename='bgm.wav') }}"),
            correct: new Audio("{{ url_for('assets', filename='correct.wav') }}"),
            wrong: new Audio("{{ url_for('assets', filename='wrong.wav') }}"),
        };
        sounds.bgm.loop = true; sounds.bgm.volume = 0.3;

        function playSound(key) { try { sounds[key].currentTime=0; sounds[key].play().catch(e=>{}); } catch(e){} }
        function toggleBGM() {
            if(sounds.bgm.paused) { playSound('bgm'); document.getElementById('bgm-status').innerText="B·∫¨T"; }
            else { sounds.bgm.pause(); document.getElementById('bgm-status').innerText="T·∫ÆT"; }
        }

        let isPlaying = false;
        let score = 0, combo = 0, lives = 3, bpm = 80;
        let targetEmo = "neutral";
        let playerEmo = "neutral";
        let beatCount = 0, gameTimer = null;

        const emotions = ["happy", "surprise", "angry", "neutral"];
        const emoMap = {
            "happy": {t:"VUI V·∫∫ üòä", i:"üòÅ"},
            "surprise": {t:"B·∫§T NG·ªú üò≤", i:"üò≤"},
            "angry": {t:"T·ª®C GI·∫¨N üò°", i:"üò°"},
            "neutral": {t:"B√åNH TH∆Ø·ªúNG üòê", i:"üòê"}
        };

        // --- CHECK LI√äN T·ª§C TR·∫†NG TH√ÅI H·ªÜ TH·ªêNG ---
        let systemCheck = setInterval(() => {
            fetch('/get_emotion').then(r=>r.json()).then(d => {
                playerEmo = d.emotion;
                let info = emoMap[playerEmo] || {t:"..."};
                document.getElementById('player-emo').innerText = info.t;
                
                // Khi Python h·ªçc xong m·∫∑t -> Chuy·ªÉn sang running
                if (d.state === "running") {
                    let btn = document.getElementById('start-btn');
                    if (btn.disabled && !isPlaying) {
                        btn.disabled = false;
                        btn.style.background = "#ff4757";
                        btn.style.cursor = "pointer";
                        btn.innerText = "‚ñ∂ B·∫ÆT ƒê·∫¶U CH∆†I!";
                        document.getElementById('top-msg').innerText = "ƒê√É S·∫¥N S√ÄNG!";
                        clearInterval(systemCheck); // Ng·ª´ng check
                        startEmotionUpdate(); // Ch·ªâ update c·∫£m x√∫c th√¥i
                    }
                }
            });
        }, 150);

        function startEmotionUpdate() {
            setInterval(()=>{
                fetch('/get_emotion').then(r=>r.json()).then(d=>{
                    playerEmo = d.emotion;
                    let info = emoMap[playerEmo];
                    document.getElementById('player-emo').innerText = info ? info.t : "...";
                });
            }, 100);
        }

        function gameLoop() {
            if(!isPlaying) return;
            let phase = beatCount % 4;
            let bar = document.getElementById('beat-bar');
            let msg = document.getElementById('top-msg');
            let card = document.getElementById('target-emoji');
            
            // Thanh th·ªùi gian
            bar.style.transition = 'none'; bar.style.width = '100%';
            setTimeout(()=>{ bar.style.transition=`width ${(60/bpm)*0.9}s linear`; bar.style.width='0%'; },20);

            if(phase===1) {
                targetEmo = emotions[Math.floor(Math.random()*emotions.length)];
                msg.innerText = "CHU·∫®N B·ªä...";
                card.classList.add('hidden');
                document.getElementById('result-popup').classList.add('hidden');
            } else if(phase===2) {
                let d = emoMap[targetEmo];
                msg.innerText = d.t;
                document.getElementById('target-icon').innerText = d.i;
                document.getElementById('target-label').innerText = d.t;
                card.classList.remove('hidden');
            } else if(phase===0) {
                let res = document.getElementById('result-popup');
                if (playerEmo === targetEmo) {
                    score += 10 + combo; combo++;
                    res.innerText = "TUY·ªÜT V·ªúI! ‚≠ê"; res.className="result-pop win";
                    playSound('correct');
                    if(combo%5===0) bpm+=5;
                } else {
                    lives--; combo=0;
                    res.innerText = "SAI R·ªíI! ‚ùå"; res.className="result-pop lose";
                    playSound('wrong');
                    if(lives<=0) {
                        isPlaying=false;
                        clearTimeout(gameTimer);
                        sounds.bgm.pause();
                        msg.innerText="GAME OVER";
                        let btn = document.getElementById('start-btn');
                        btn.innerText="CH∆†I L·∫†I?"; btn.style.display="block";
                    }
                }
                res.classList.remove('hidden');
                document.getElementById('score').innerText = score;
                document.getElementById('combo').innerText = combo;
                document.getElementById('lives').innerText = lives>0 ? "‚ù§Ô∏è".repeat(lives) : "üíî";
            }
            gameTimer = setTimeout(gameLoop, 60000/bpm);
            beatCount++;
        }

        function initGame() {
            playSound('bgm');
            score=0; combo=0; lives=3; bpm=80; beatCount=1;
            isPlaying=true;
            document.getElementById('start-btn').style.display='none';
            gameLoop();
        }
    </script>
</body>
</html>